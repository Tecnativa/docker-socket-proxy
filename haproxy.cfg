global
    log stdout format raw daemon "${LOG_LEVEL}"

    pidfile /run/haproxy.pid
    maxconn 4000

    # Turn on stats unix socket
    server-state-file /var/lib/haproxy/server-state

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option http-server-close
    option redispatch
    retries 3
    timeout http-request 10s
    timeout queue 1m
    timeout connect 10s
    timeout client 10m
    timeout server 10m
    timeout http-keep-alive 10s
    timeout check 10s
    maxconn 3000

    # Allow seamless reloads
    load-server-state-from-file global

    # Use provided example error pages
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

backend dockerbackend
    server dockersocket $SOCKET_PATH

backend docker-events
    server dockersocket $SOCKET_PATH
    timeout server 0

frontend dockerfrontend
    bind ${BIND_CONFIG}

    # --- Method ACLs ---
    acl method_GET     method GET
    acl method_HEAD    method HEAD
    acl method_POST    method POST
    acl method_DELETE  method DELETE
    acl method_PUT     method PUT
    acl method_PATCH   method PATCH

    # --- Allow only enabled methods ---
    http-request deny unless METH_GET || method_POST { env(POST) -m bool } || method_DELETE { env(DELETE) -m bool } || method_PUT { env(PUT) -m bool } || method_PATCH { env(PATCH) -m bool }

    # --- Allowed endpoints ---
    # GET, HEAD, PUT & PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/auth } { env(AUTH) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/build } { env(BUILD) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/commit } { env(COMMIT) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/configs } { env(CONFIGS) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/containers } { env(CONTAINERS) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/distribution } { env(DISTRIBUTION) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/events } { env(EVENTS) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/exec } { env(EXEC) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/grpc } { env(GRPC) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/images } { env(IMAGES) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/info } { env(INFO) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/networks } { env(NETWORKS) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/nodes } { env(NODES) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/_ping } { env(PING) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/plugins } { env(PLUGINS) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/secrets } { env(SECRETS) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/services } { env(SERVICES) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/session } { env(SESSION) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/swarm } { env(SWARM) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/system } { env(SYSTEM) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/tasks } { env(TASKS) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/version } { env(VERSION) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH
    http-request allow if { path,url_dec -m reg -i ^(/v[\d\.]+)?/volumes } { env(VOLUMES) -m bool } method_GET || method_HEAD || method_PUT || method_PATCH

    # POST and DELETE
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/containers/[a-zA-Z0-9_.-]+/((stop)|(restart)|(kill)) } { env(ALLOW_RESTARTS) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/containers/[a-zA-Z0-9_.-]+/start } { env(ALLOW_START) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/containers/[a-zA-Z0-9_.-]+/stop } { env(ALLOW_STOP) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/auth }        { env(AUTH) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/build }       { env(BUILD) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/commit }      { env(COMMIT) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/configs }     { env(CONFIGS) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/containers }  { env(CONTAINERS) -m bool }
    http-request allow if method_DELETE { path,url_dec -m reg -i ^(/v[\d\.]+)?/containers }{ env(ALLOW_CONTAINERS_DELETE) -m bool } { env(CONTAINERS) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/distribution }{ env(DISTRIBUTION) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/events }      { env(EVENTS) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/exec }        { env(EXEC) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/grpc }        { env(GRPC) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/images }      { env(IMAGES) -m bool }
    http-request allow if method_DELETE { path,url_dec -m reg -i ^(/v[\d\.]+)?/images }    { env(ALLOW_IMAGES_DELETE) -m bool } { env(IMAGES) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/networks }    { env(NETWORKS) -m bool }
    http-request allow if method_DELETE { path,url_dec -m reg -i ^(/v[\d\.]+)?/networks }  { env(ALLOW_NETWORKS_DELETE) -m bool } { env(NETWORKS) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/nodes }       { env(NODES) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/_ping }       { env(PING) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/plugins }     { env(PLUGINS) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/secrets }     { env(SECRETS) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/services }    { env(SERVICES) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/session }     { env(SESSION) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/swarm }       { env(SWARM) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/system }      { env(SYSTEM) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/tasks }       { env(TASKS) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/version }     { env(VERSION) -m bool }
    http-request allow if method_POST { path,url_dec -m reg -i ^(/v[\d\.]+)?/volumes }     { env(VOLUMES) -m bool }

    # --- Default deny everything else ---
    http-request deny

    default_backend dockerbackend
    use_backend docker-events if { path,url_dec -m reg -i ^(/v[\d\.]+)?/events }
